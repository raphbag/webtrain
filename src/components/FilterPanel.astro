---
// Composant de panneau de filtres pour les lignes de transport
---

<div id="filterPanel" class="fixed top-[100px] left-5 w-80 max-h-[calc(100vh-120px)] bg-slate-400/15 backdrop-blur-xl -webkit-backdrop-blur-xl border border-white/20 rounded-2xl shadow-lg z-50 hidden flex-col transition-all duration-300 hover:bg-slate-400/25 hover:shadow-2xl [&_input[type=checkbox]]:appearance-none [&_input[type=checkbox]]:w-4 [&_input[type=checkbox]]:h-4 [&_input[type=checkbox]]:border-2 [&_input[type=checkbox]]:border-white/60 [&_input[type=checkbox]]:rounded [&_input[type=checkbox]]:bg-white/10 [&_input[type=checkbox]]:cursor-pointer [&_input[type=checkbox]]:flex-shrink-0 [&_input[type=checkbox]:checked]:bg-white/90 [&_input[type=checkbox]:checked]:border-white/90 [&_input[type=checkbox]]:relative [&_input[type=checkbox]:checked]:after:content-['✓'] [&_input[type=checkbox]:checked]:after:absolute [&_input[type=checkbox]:checked]:after:top-1/2 [&_input[type=checkbox]:checked]:after:left-1/2 [&_input[type=checkbox]:checked]:after:-translate-x-1/2 [&_input[type=checkbox]:checked]:after:-translate-y-1/2 [&_input[type=checkbox]:checked]:after:text-slate-800 [&_input[type=checkbox]:checked]:after:text-xs [&_input[type=checkbox]:checked]:after:font-bold">
	<div id="filterHeader" class="flex justify-between items-center p-5 border-b border-white/20 backdrop-blur-lg">
		<h3 class="m-0 text-lg font-bold text-white drop-shadow-[0_2px_10px_rgba(0,0,0,0.2)]">Filtres</h3>
		<button id="toggleFilters" aria-label="Toggle filters" class="bg-white/20 border border-white/30 text-xl cursor-pointer p-0 w-8 h-8 flex items-center justify-center rounded-lg text-white transition-all duration-300 font-bold hover:bg-white/30 hover:scale-110">−</button>
	</div>
	<div id="filterContent" class="overflow-y-auto flex-1 p-4 [&::-webkit-scrollbar]:w-2 [&::-webkit-scrollbar-track]:bg-white/5 [&::-webkit-scrollbar-track]:rounded-lg [&::-webkit-scrollbar-thumb]:bg-white/30 [&::-webkit-scrollbar-thumb]:rounded-lg [&::-webkit-scrollbar-thumb:hover]:bg-white/40">
		<div class="flex gap-2 mb-4">
			<button id="selectAllBtn" class="flex-1 py-2.5 px-3.5 text-xs border border-white/30 bg-white/30 backdrop-blur-lg rounded-lg cursor-pointer transition-all duration-300 font-semibold text-white drop-shadow-[0_1px_3px_rgba(0,0,0,0.2)] hover:bg-white/25 hover:border-white/40 hover:scale-105">Tout sélectionner</button>
			<button id="deselectAllBtn" class="flex-1 py-2.5 px-3.5 text-xs border border-white/30 bg-white/30 backdrop-blur-lg rounded-lg cursor-pointer transition-all duration-300 font-semibold text-white drop-shadow-[0_1px_3px_rgba(0,0,0,0.2)] hover:bg-white/25 hover:border-white/40 hover:scale-105">Tout désélectionner</button>
		</div>
		<div id="filterCategories"></div>
	</div>
</div>

<script>
	// Module pour gérer les filtres de lignes de transport
	interface LineData {
		routeId: string;
		routeName: string;
		routeColor: string;
		routeType: string;
		properties: any;
		polylines: any[];
		visible: boolean;
		imageUrl?: string;
		originalRouteId?: string;
		stops?: any[];
	}

	interface Categories {
		[categoryName: string]: string[];
	}

	// Variables globales pour le filtre (accessibles depuis la page)
	declare global {
		interface Window {
			filterPanelData: {
				allLines: { [routeId: string]: LineData };
				categories: Categories;
				map: any | null;
				allStops: { [routeId: string]: any[] };
			};
			buildFilterUI: () => void;
			showFilterPanel: () => void;
			updateStopsVisibility?: () => void;
		}
	}

	// Initialiser le stockage global
	if (!window.filterPanelData) {
		window.filterPanelData = {
			allLines: {},
			categories: {},
			map: null,
			allStops: {}
		};
	}

	// Fonction pour toggle le panneau de filtres
	function toggleFilterPanel() {
		const content = document.getElementById('filterContent');
		const toggle = document.getElementById('toggleFilters');
		
		if (!content || !toggle) return;
		
		const isHidden = content.classList.contains('hidden');
		if (isHidden) {
			content.classList.remove('hidden');
			toggle.textContent = '−';
		} else {
			content.classList.add('hidden');
			toggle.textContent = '+';
		}
	}

	// Fonction pour sélectionner toutes les lignes
	function selectAllLines() {
		const { allLines, categories } = window.filterPanelData;
		Object.keys(allLines).forEach(routeId => toggleLine(routeId, true));
		Object.keys(categories).forEach(updateCategoryCheckbox);
	}

	// Fonction pour désélectionner toutes les lignes
	function deselectAllLines() {
		const { allLines, categories } = window.filterPanelData;
		Object.keys(allLines).forEach(routeId => toggleLine(routeId, false));
		Object.keys(categories).forEach(updateCategoryCheckbox);
	}

	// Fonction pour afficher/masquer une ligne
	function toggleLine(routeId: string, visible: boolean) {
		const { allLines, map } = window.filterPanelData;
		const line = allLines[routeId];
		if (!line || !map) return;
		
		line.visible = visible;
		line.polylines.forEach(polyline => {
			polyline.setMap(visible ? map : null);
		});
		
		// Mettre à jour l'affichage des arrêts
		if (window.updateStopsVisibility) {
			window.updateStopsVisibility();
		}
		
		// Mettre à jour la checkbox
		const checkbox = document.querySelector(`.line-checkbox[data-route-id="${routeId}"]`) as HTMLInputElement;
		if (checkbox) checkbox.checked = visible;
	}

	// Fonction pour mettre à jour la checkbox de catégorie
	function updateCategoryCheckbox(categoryName: string) {
		const { allLines, categories } = window.filterPanelData;
		const routeIds = categories[categoryName];
		if (!routeIds) return;
		
		const visibleCount = routeIds.filter(id => allLines[id]?.visible).length;
		
		const checkbox = document.querySelector(`.category-checkbox[data-category="${categoryName}"]`) as HTMLInputElement;
		const countSpan = checkbox?.parentElement?.querySelector('.category-count');
		
		if (checkbox) {
			checkbox.checked = visibleCount === routeIds.length;
			checkbox.indeterminate = visibleCount > 0 && visibleCount < routeIds.length;
		}
		if (countSpan) {
			countSpan.textContent = `${visibleCount}/${routeIds.length}`;
		}
	}

	// Fonction pour construire l'UI des filtres
	function buildFilterUI() {
		const { allLines, categories } = window.filterPanelData;
		const container = document.getElementById('filterCategories');
		if (!container) return;
		
		container.innerHTML = '';
		
		// Ordre des catégories souhaité
		const categoryOrder = ['Métro', 'RER', 'Transilien', 'TER', 'Tram'];
		const sortedCategories = categoryOrder.filter(cat => categories[cat]);
		
		sortedCategories.forEach(categoryName => {
			const categoryDiv = document.createElement('div');
			categoryDiv.className = 'mb-3 border border-white/25 rounded-xl overflow-hidden bg-white/10 backdrop-blur-xl transition-all duration-300 hover:bg-white/15 hover:border-white/35';
			
			const routeIds = categories[categoryName];
			const visibleCount = routeIds.filter(id => allLines[id]?.visible).length;
			
			// Header de catégorie (réduit par défaut)
			const header = document.createElement('div');
			header.className = 'flex items-center p-3 bg-white/5 cursor-pointer select-none transition-all duration-300 hover:bg-white/15';
			header.classList.add('collapsed');
			header.innerHTML = `
				<input type="checkbox" class="category-checkbox mr-3" ${visibleCount === routeIds.length ? 'checked' : ''} data-category="${categoryName}">
				<span class="category-name flex-1 font-bold text-sm text-white drop-shadow-[0_1px_3px_rgba(0,0,0,0.2)]">${categoryName}</span>
				<span class="category-count text-xs text-white/80 mr-2 font-semibold bg-white/10 px-2 py-0.5 rounded">${visibleCount}/${routeIds.length}</span>
				<span class="category-toggle text-base text-white/90 transition-transform duration-300" style="transform: rotate(-90deg);">▼</span>
			`;
			
			// Liste des lignes
			const linesList = document.createElement('div');
			linesList.className = 'max-h-60 overflow-y-auto bg-white/5 hidden';
			
			// Trier les lignes par nom
			const sortedLines = routeIds
				.map(id => allLines[id])
				.filter(line => line)
				.sort((a, b) => {
					const aNum = parseInt(a.routeName) || 0;
					const bNum = parseInt(b.routeName) || 0;
					if (aNum && bNum) return aNum - bNum;
					return a.routeName.localeCompare(b.routeName);
				});
			
			sortedLines.forEach(line => {
				const lineItem = document.createElement('div');
				lineItem.className = 'flex items-center py-2 px-3 border-t border-white/10 text-sm transition-all duration-200 hover:bg-white/15';
				
				// Utiliser l'image si disponible, sinon l'indicateur de couleur
				let lineVisual = '';
				if (line.imageUrl) {
					lineVisual = `<img src="${line.imageUrl}" alt="${line.routeName}" class="h-7 max-w-xs object-contain mr-2 flex-shrink-0 drop-shadow-[0_2px_4px_rgba(0,0,0,0.2)]" loading="lazy" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
					              <div class="rounded flex-shrink-0 shadow-sm hidden" style="width: 1.375rem; height: 1.375rem; background-color: ${line.routeColor}; display: none;"></div>`;
				} else {
					lineVisual = `<div class="rounded flex-shrink-0 shadow-sm" style="width: 1.375rem; height: 1.375rem; background-color: ${line.routeColor};"></div>`;
				}
				
				lineItem.innerHTML = `
					<input type="checkbox" class="line-checkbox mr-2" ${line.visible ? 'checked' : ''} data-route-id="${line.routeId}">
					${lineVisual}
					<span class="line-name flex-1 font-semibold text-white drop-shadow-[0_1px_3px_rgba(0,0,0,0.2)]">${line.routeName}</span>
				`;
				linesList.appendChild(lineItem);
				
				// Event listener pour la checkbox de ligne
				const checkbox = lineItem.querySelector('.line-checkbox') as HTMLInputElement;
				checkbox.addEventListener('change', (e) => {
					const target = e.target as HTMLInputElement;
					toggleLine(line.routeId, target.checked);
					updateCategoryCheckbox(categoryName);
				});
			});
			
			categoryDiv.appendChild(header);
			categoryDiv.appendChild(linesList);
			container.appendChild(categoryDiv);
			
			// Event listener pour le header (toggle liste)
			header.addEventListener('click', (e) => {
				const target = e.target as HTMLElement;
				// Empêcher la propagation si on clique sur la checkbox
				if (target.classList.contains('category-checkbox')) {
					e.stopPropagation();
					const checkbox = target as HTMLInputElement;
					const checked = checkbox.checked;
					routeIds.forEach(id => toggleLine(id, checked));
					updateCategoryCheckbox(categoryName);
					return;
				}
				
				// Toggle collapse pour tout autre clic
				header.classList.toggle('collapsed');
				const toggle = header.querySelector('.category-toggle') as HTMLElement | null;
				if (header.classList.contains('collapsed')) {
					linesList.classList.add('hidden');
					if (toggle) toggle.style.transform = 'rotate(-90deg)';
				} else {
					linesList.classList.remove('hidden');
					if (toggle) toggle.style.transform = '';
				}
			});
		});
	}

	// Fonction pour afficher le panneau
	function showFilterPanel() {
		const panel = document.getElementById('filterPanel');
		if (panel) {
			panel.classList.remove('hidden');
			panel.classList.add('flex');
		}
	}

	// Exposer les fonctions globalement
	window.buildFilterUI = buildFilterUI;
	window.showFilterPanel = showFilterPanel;

	// Initialiser les event listeners
	document.addEventListener('DOMContentLoaded', () => {
		const toggleBtn = document.getElementById('toggleFilters');
		const selectAllBtn = document.getElementById('selectAllBtn');
		const deselectAllBtn = document.getElementById('deselectAllBtn');
		
		if (toggleBtn) {
			toggleBtn.addEventListener('click', toggleFilterPanel);
		}
		
		if (selectAllBtn) {
			selectAllBtn.addEventListener('click', selectAllLines);
		}
		
		if (deselectAllBtn) {
			deselectAllBtn.addEventListener('click', deselectAllLines);
		}
	});
</script>

